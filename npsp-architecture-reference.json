{
  "meta": {
    "title": "Salesforce NPSP (Nonprofit Success Pack) - Comprehensive Architecture Reference",
    "repository": "https://github.com/SalesforceFoundation/NPSP",
    "license": "BSD-3-Clause",
    "languages": {
      "apex": "76.4%",
      "javascript": "13.0%",
      "html": "5.2%",
      "other": "5.4%"
    },
    "stats": {
      "total_commits": 46609,
      "apex_classes": 843,
      "tdtm_triggers": 26,
      "tdtm_handler_classes": 48,
      "batch_classes": 45,
      "lwc_components": "100+",
      "custom_objects": 65
    },
    "generated": "2026-02-19",
    "generated_by": "Ava Sterling / Claude Opus 4.6"
  },

  "overview": {
    "name": "Nonprofit Success Pack (NPSP)",
    "description": "NPSP is an open-source managed package built on top of Salesforce Sales/Service Cloud that provides nonprofits with a purpose-built CRM. It transforms the standard Salesforce data model (which is sales-oriented) into a donor-centric model using Accounts as Households, Contacts as individual donors, and Opportunities as donations. It adds recurring donations, payment tracking, soft credits, fund allocations, engagement plans, address management, relationships, and comprehensive rollup summaries.",
    "who_uses_it": "Nonprofit organizations of all sizes using Salesforce, from small community foundations to large international NGOs. Over 40,000 nonprofits have used NPSP. It is the foundation of the 'Salesforce for Nonprofits' ecosystem.",
    "core_value_proposition": "Turns a generic sales CRM into a donor management system without custom development. Provides household-based contact management, automated donation tracking, flexible recurring gifts, fund accounting via allocations, and rich rollup analytics -- all configured through clicks, not code.",
    "strategic_context": "NPSP is in maintenance mode as of 2023. Salesforce launched Nonprofit Cloud as the successor platform, built natively into the Salesforce platform rather than as a managed package. However, NPSP remains widely deployed and supported, and its architectural patterns (especially TDTM) have influenced the broader Salesforce ecosystem."
  },

  "architecture": {
    "description": "NPSP follows a layered architecture with clear separation of concerns. The codebase is organized into functional domains identified by consistent naming prefixes. Every trigger passes through the TDTM (Table-Driven Trigger Management) framework, which acts as a universal dispatch layer. Business logic lives in handler classes (suffixed _TDTM) that extend the abstract TDTM_Runnable base class.",
    "layers": [
      {
        "name": "UI Layer (Lightning Web Components + Visualforce)",
        "description": "100+ Lightning Web Components for gift entry, recurring donation management, settings UI, getting-started checklists, and donor views. Legacy Visualforce pages remain for settings panels (STG_Panel* classes) and batch data entry.",
        "key_prefixes": ["ge*", "rd2*", "gs*", "bdi*", "util*"],
        "examples": [
          "geGiftEntryFormApp - Main gift entry form application",
          "rd2EntryForm - Enhanced recurring donation entry form",
          "gsChecklist - Getting started checklist",
          "geTemplateBuilder - Gift entry template builder",
          "relationshipsTreeGrid - Relationship visualization"
        ]
      },
      {
        "name": "Controller / API Layer",
        "description": "Apex controllers that serve as the bridge between UI components and business logic. These are typically @AuraEnabled methods in controller classes or the TDTM_Config_API global API class.",
        "key_classes": [
          "TDTM_Config_API - Global entry point for TDTM trigger dispatch",
          "GE_GiftEntryController - Gift entry LWC controller",
          "RD2_EntryFormController - Recurring donation form controller",
          "STG_Panel*_CTRL - Settings panel controllers (one per settings section)",
          "CRLP_ApiService - Rollup configuration API"
        ]
      },
      {
        "name": "Trigger Dispatch Layer (TDTM Framework)",
        "description": "The heart of NPSP's architecture. One thin trigger per object delegates to TDTM_TriggerHandler.run(), which reads the Trigger_Handler__c custom object to determine which handler classes to invoke, in what order, for which trigger actions. This allows admins to enable/disable/reorder handlers without code changes.",
        "key_classes": [
          "TDTM_TriggerHandler - Central dispatcher that routes trigger events to registered handlers",
          "TDTM_Runnable - Abstract base class all handlers must extend",
          "TDTM_DefaultConfig - Defines the default set of ~50 handler registrations",
          "TDTM_ObjectDataGateway - Data access for Trigger_Handler__c records",
          "TDTM_TriggerActionHelper - Determines the action enum from trigger context booleans"
        ]
      },
      {
        "name": "Service / Business Logic Layer",
        "description": "Domain-specific handler classes organized by functional prefix (ALLO_, PMT_, RD2_, CRLP_, etc.). Each handler extends TDTM_Runnable and implements the run() method. Supporting service classes (*_SVC, *_UTIL) contain reusable logic.",
        "key_prefixes": {
          "ACCT_": "Account management (5 classes)",
          "ADDR_": "Address management and verification (20 classes)",
          "AFFL_": "Affiliations between contacts and organizations",
          "ALLO_": "Fund allocations to GAUs (28 classes)",
          "BDI_": "Batch Data Import engine (66 classes)",
          "BGE_": "Batch Gift Entry (9 classes)",
          "CON_": "Contact management, merge, do-not-contact (16 classes)",
          "CRLP_": "Customizable Rollups engine (76 classes)",
          "EP_": "Engagement Plans (12 classes)",
          "ERR_": "Error handling and logging (22 classes)",
          "GE_": "Gift Entry (10 classes)",
          "HH_": "Household management and naming (18 classes)",
          "LVL_": "Levels / donor tiers (6 classes)",
          "MTCH_": "Matching gifts (4 classes)",
          "OPP_": "Opportunity management, naming, contact roles (29 classes)",
          "PMT_": "Payment management (15 classes)",
          "PSC_": "Partial soft credits (5 classes)",
          "PS_": "Payment services / Elevate integration (14 classes)",
          "RD_": "Legacy recurring donations (13 classes)",
          "RD2_": "Enhanced recurring donations v2 (89 classes)",
          "REL_": "Relationships between contacts (6 classes)",
          "RLLP_": "Legacy rollups (12 classes)",
          "STG_": "Settings and configuration UI (64 classes)",
          "UTIL_": "Shared utilities (93 classes)"
        }
      },
      {
        "name": "Data Access Layer",
        "description": "The UTIL_CustomSettingsFacade class provides a unified facade for all custom settings. TDTM_ObjectDataGateway handles Trigger_Handler__c queries. Individual domains use inline SOQL or selector patterns.",
        "key_classes": [
          "UTIL_CustomSettingsFacade - Central facade for all 14+ custom settings objects",
          "TDTM_ObjectDataGateway - Reads/caches trigger handler configurations",
          "UTIL_Describe - SObject and field describe cache",
          "UTIL_Namespace - Handles managed package namespace resolution",
          "CRLP_Rollup_SEL - Rollup metadata selector/cache"
        ]
      },
      {
        "name": "Batch Processing Layer",
        "description": "45 batch Apex classes handle asynchronous processing for rollups, data import, migration, housekeeping, and scheduled maintenance. NPSP schedules several of these to run nightly.",
        "key_classes": [
          "CRLP_Batch_Base - Abstract base for all rollup batch jobs",
          "BDI_DataImport_BATCH - Core batch data import processor",
          "RD2_OpportunityEvaluation_BATCH - Recurring donation opportunity creation",
          "RLLP_OppAccRollup_BATCH - Legacy account rollups",
          "LVL_LevelAssign_BATCH - Donor level/tier assignment"
        ]
      }
    ],
    "directory_structure": {
      "force-app/main/default/classes/": "843 Apex classes (business logic, services, utilities)",
      "force-app/main/default/lwc/": "100+ Lightning Web Components",
      "force-app/main/default/objects/": "65 custom objects and standard object customizations",
      "force-app/tdtm/triggers/": "26 TDTM triggers (one per object)",
      "force-app/tdtm/classes/": "TDTM framework classes (Runnable, TriggerHandler, DefaultConfig)",
      "force-app/tdtm/objects/Trigger_Handler__c/": "Trigger handler configuration object",
      "robot/": "Robot Framework automated tests",
      "datasets/": "Test data and seed data",
      "unpackaged/": "Metadata not included in the managed package"
    }
  },

  "feature_areas": [
    {
      "name": "Table-Driven Trigger Management (TDTM)",
      "description": "NPSP's foundational architectural pattern. Instead of writing individual triggers with inline logic, NPSP uses ONE trigger per object that delegates to a central dispatcher (TDTM_TriggerHandler). The dispatcher reads the Trigger_Handler__c custom object to determine which handler classes to invoke, in what order, and for which trigger events. Handlers can be activated/deactivated, reordered, and even run asynchronously -- all via point-and-click configuration.",
      "why_it_matters": "This pattern eliminates trigger conflicts in a managed package ecosystem. Customers can add their own handlers alongside NPSP's without touching code. It also enables NPSP to ship updates to handler logic without breaking customer customizations.",
      "key_components": {
        "triggers": [
          "TDTM_Account.trigger",
          "TDTM_Contact.trigger",
          "TDTM_Opportunity.trigger",
          "TDTM_Payment.trigger",
          "TDTM_RecurringDonation.trigger",
          "TDTM_Allocation.trigger",
          "TDTM_Address.trigger",
          "TDTM_Affiliation.trigger",
          "TDTM_Relationship.trigger",
          "TDTM_EngagementPlan.trigger",
          "TDTM_EngagementPlanTask.trigger",
          "TDTM_Campaign.trigger",
          "TDTM_CampaignMember.trigger",
          "TDTM_DataImport.trigger",
          "TDTM_DataImportBatch.trigger",
          "TDTM_FormTemplate.trigger",
          "TDTM_GeneralAccountingUnit.trigger",
          "TDTM_GrantDeadline.trigger",
          "TDTM_HouseholdObject.trigger",
          "TDTM_Lead.trigger",
          "TDTM_Level.trigger",
          "TDTM_PartialSoftCredit.trigger",
          "TDTM_AccountSoftCredit.trigger",
          "TDTM_Task.trigger",
          "TDTM_User.trigger"
        ],
        "framework_classes": [
          "TDTM_TriggerHandler",
          "TDTM_Runnable",
          "TDTM_RunnableMutable",
          "TDTM_DefaultConfig",
          "TDTM_ObjectDataGateway",
          "TDTM_TriggerActionHelper",
          "TDTM_Config_API"
        ],
        "configuration_object": "Trigger_Handler__c"
      },
      "data_objects": ["Trigger_Handler__c"],
      "trigger_handler_fields": {
        "Active__c": "Boolean - whether this handler is active",
        "Asynchronous__c": "Boolean - run handler as @future method",
        "Class__c": "Text - the Apex class name to instantiate (must extend TDTM_Runnable)",
        "Load_Order__c": "Number - execution order (lower runs first)",
        "Object__c": "Text - the SObject API name this handler fires on",
        "Trigger_Action__c": "Text - semicolon-delimited list (e.g., 'BeforeInsert;AfterUpdate')",
        "User_Managed__c": "Boolean - prevents NPSP from overwriting customer-created handlers",
        "Usernames_to_Exclude__c": "Text - usernames for which this handler should NOT run"
      },
      "connects_to": ["Every other feature area - TDTM is the execution backbone for all NPSP logic"],
      "code_snippet": {
        "description": "TDTM trigger pattern - every NPSP trigger looks like this",
        "language": "apex",
        "code": "// force-app/tdtm/triggers/TDTM_Contact.trigger\ntrigger TDTM_Contact on Contact (after delete, after insert, after undelete,\n    after update, before delete, before insert, before update) {\n\n    TDTM_Config_API.run(Trigger.isBefore, Trigger.isAfter, Trigger.isInsert,\n        Trigger.isUpdate, Trigger.isDelete, Trigger.isUnDelete,\n        Trigger.new, Trigger.old, Schema.Sobjecttype.Contact);\n}"
      },
      "code_snippet_2": {
        "description": "TDTM handler registration - how handlers are registered in TDTM_DefaultConfig",
        "language": "apex",
        "code": "// From TDTM_DefaultConfig.getDefaultRecords()\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true,\n    Asynchronous__c = false,\n    Class__c = 'ACCT_IndividualAccounts_TDTM',\n    Load_Order__c = 1,\n    Object__c = 'Contact',\n    Trigger_Action__c = 'BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate;AfterDelete;AfterUndelete'\n));"
      },
      "code_snippet_3": {
        "description": "TDTM_Runnable abstract base class that all handlers extend",
        "language": "apex",
        "code": "// force-app/tdtm/classes/TDTM_Runnable.cls\nglobal abstract class TDTM_Runnable {\n\n    global abstract DmlWrapper run(\n        List<SObject> newlist,\n        List<SObject> oldlist,\n        Action triggerAction,\n        Schema.DescribeSObjectResult objResult\n    );\n\n    global class DmlWrapper {\n        global List<SObject> objectsToInsert = new List<SObject>();\n        global List<SObject> objectsToUpdate = new List<SObject>();\n        global List<SObject> objectsToDelete = new List<SObject>();\n        global List<SObject> objectsToUndelete = new List<SObject>();\n    }\n\n    global enum Action {\n        BeforeInsert, BeforeUpdate, BeforeDelete,\n        AfterInsert, AfterUpdate, AfterDelete, AfterUndelete\n    }\n}"
      }
    },

    {
      "name": "Donations & Payments",
      "description": "Manages the complete donation lifecycle. Opportunities represent donations, and each Opportunity can have one or more Payment records (npe01__OppPayment__c). NPSP auto-creates payments when Opportunities are created, syncs payment status with Opportunity stage, and enforces accounting data consistency between payments and their parent Opportunities.",
      "key_components": {
        "handler_classes": [
          "PMT_Payment_TDTM - Handles payment creation, sync, and currency validation on both Opportunity and Payment objects",
          "PMT_PaymentCreator_BATCH - Batch creation of payment records",
          "PMT_CascadeDeleteLookups_TDTM - Cascade delete support for payments",
          "OPP_OpportunityContactRoles_TDTM - Manages primary and soft credit contact roles",
          "OPP_CampaignMember_TDTM - Creates campaign member records from Opportunity data",
          "HH_OppContactRoles_TDTM - Household-aware opportunity contact role management",
          "OPP_OpportunityNaming_BATCH - Batch renaming of opportunities"
        ],
        "service_classes": [
          "PMT_PaymentCreator - Payment creation logic",
          "OPP_OpportunityNaming - Opportunity name generation from templates"
        ]
      },
      "data_objects": [
        "Opportunity (standard) - represents a donation",
        "npe01__OppPayment__c - child payment records",
        "OpportunityContactRole (standard) - links contacts to opportunities",
        "npe01__Contacts_And_Orgs_Settings__c - payment/contact settings"
      ],
      "connects_to": [
        "Customizable Rollups (CRLP) - rollup donation totals to Account/Contact",
        "Allocations - split donation amounts across funds",
        "Recurring Donations - auto-generated opportunities",
        "Soft Credits - non-primary donor attribution",
        "Engagement Plans - tasks triggered by donations",
        "Households - household-level donation tracking"
      ],
      "code_snippet": {
        "description": "PMT_Payment_TDTM handler pattern for payment processing",
        "language": "apex",
        "code": "// force-app/main/default/classes/PMT_Payment_TDTM.cls\npublic class PMT_Payment_TDTM extends TDTM_Runnable {\n\n    private static final npo02__Households_Settings__c householdSettings =\n        UTIL_CustomSettingsFacade.getHouseholdsSettings();\n\n    private Boolean isEnforceAccountingDataConsistency {\n        get {\n            if (isEnforceAccountingDataConsistency == null) {\n                isEnforceAccountingDataConsistency =\n                    UTIL_CustomSettingsFacade.getContactsSettings()\n                        .Enforce_Accounting_Data_Consistency__c;\n            }\n            return isEnforceAccountingDataConsistency;\n        }\n        set;\n    }\n\n    public override DmlWrapper run(List<SObject> newlist, List<SObject> oldlist,\n        TDTM_Runnable.Action triggerAction,\n        Schema.DescribeSObjectResult objResult) {\n        // Payment creation, sync, and validation logic\n    }\n}"
      }
    },

    {
      "name": "Recurring Donations (Enhanced - RD2)",
      "description": "The enhanced recurring donations engine (v2, prefix RD2_) is one of NPSP's most complex subsystems with 89 Apex classes. It manages scheduled recurring gifts with configurable frequencies, amounts, and date ranges. The engine auto-generates Opportunity records on schedule, handles pauses, status automation, change logging, and integrates with Elevate payment processing.",
      "key_components": {
        "handler_classes": [
          "RD2_RecurringDonations_TDTM - Main trigger handler on npe03__Recurring_Donation__c",
          "RD2_RecurringDonationsOpp_TDTM - Handles Opportunity events related to recurring donations",
          "RD_RecurringDonations_TDTM - Legacy handler (still registered for backward compatibility)",
          "RD_RecurringDonations_Opp_TDTM - Legacy Opportunity handler"
        ],
        "service_classes": [
          "RD2_ScheduleService - Manages installment schedules and date calculations",
          "RD2_NamingService - Auto-naming for recurring donation records",
          "RD2_OpportunityService - Creates/updates opportunities from schedules",
          "RD2_StatusAutomationService - Automated status transitions (Active/Lapsed/Closed)",
          "RD2_ValidationService - Validates recurring donation data",
          "RD2_OpportunityMatcher - Matches existing opportunities to installments",
          "RD2_ElevateIntegrationService - Integration with Salesforce Elevate payments"
        ],
        "batch_classes": [
          "RD2_OpportunityEvaluation_BATCH - Nightly evaluation and creation of installment opportunities",
          "RD2_DataMigration_BATCH - Migrates from legacy to enhanced recurring donations",
          "RD2_DataMigrationDryRun_BATCH - Dry run migration for validation",
          "RD2_DataMigrationBase_BATCH - Base class for migration batches"
        ],
        "lwc_components": [
          "rd2EntryForm - Main entry/edit form",
          "rd2EntryFormDonorSection - Donor selection section",
          "rd2EntryFormScheduleSection - Schedule configuration",
          "rd2RecurringDonation - Overview component",
          "rd2ChangeLog - Change history viewer",
          "rd2PauseForm - Pause/resume interface",
          "rd2StatusMappingSettings - Status mapping configuration",
          "rd2StatusAutomationSettings - Automation rules configuration",
          "rdScheduleVisualizer - Visual schedule display",
          "stopRecurringDonationModal - Stop/close modal"
        ]
      },
      "data_objects": [
        "npe03__Recurring_Donation__c - The recurring donation record",
        "RecurringDonationSchedule__c - Individual schedule installment records",
        "RecurringDonationChangeLog__c - Change history records",
        "RecurringDonationStatusMapping__mdt - Custom metadata for status mapping",
        "npe03__Recurring_Donations_Settings__c - RD configuration settings",
        "Opportunity - Generated installment opportunities"
      ],
      "connects_to": [
        "Donations & Payments - Generates opportunities and payments on schedule",
        "Allocations - Recurring donation allocations propagate to generated opportunities",
        "Customizable Rollups - RD fields are rollup targets",
        "Payment Services (Elevate) - Recurring payment processing"
      ],
      "code_snippet": {
        "description": "RD2_RecurringDonations_TDTM handler with schedule service injection",
        "language": "apex",
        "code": "// force-app/main/default/classes/RD2_RecurringDonations_TDTM.cls\npublic class RD2_RecurringDonations_TDTM extends TDTM_Runnable {\n\n    private DmlWrapper dmlActions = new DmlWrapper();\n\n    @TestVisible\n    private RD2_ScheduleService scheduleService {\n        get {\n            if (scheduleService == null) {\n                scheduleService = new RD2_ScheduleService();\n            }\n            return scheduleService;\n        }\n        set;\n    }\n\n    public override DmlWrapper run(List<SObject> newlist, List<SObject> oldlist,\n        TDTM_Runnable.Action triggerAction,\n        Schema.DescribeSObjectResult objResult) {\n        // Validates, builds schedules, evaluates opportunities\n    }\n}"
      }
    },

    {
      "name": "Customizable Rollups (CRLP)",
      "description": "NPSP's most architecturally sophisticated subsystem with 76 Apex classes. CRLP replaces the legacy hardcoded rollups (RLLP_*) with a metadata-driven rollup engine. Rollup definitions are stored in Rollup__mdt custom metadata, with filtering via Filter_Group__mdt and Filter_Rule__mdt. The engine supports rolling up Opportunity and Payment data to Account, Contact, GAU, and Recurring Donation summary objects. It operates in two modes: NonSkew (query summary records) for normal volumes and SkewMode (query detail records) for accounts with many child records.",
      "key_components": {
        "handler_classes": [
          "CRLP_Rollup_TDTM - Trigger handler on Opportunity and Payment; initiates real-time rollup recalculation",
          "RLLP_OppRollup_TDTM - Legacy rollup trigger handler (active when CRLP not enabled)"
        ],
        "engine_classes": [
          "CRLP_RollupProcessor_SVC - Routes to the correct handler class based on rollup type",
          "CRLP_Rollup_SVC - Core rollup service, determines if CRLP is enabled",
          "CRLP_RollupAccount_SVC - Account hard credit rollup logic",
          "CRLP_RollupContact_SVC - Contact hard credit rollup logic",
          "CRLP_RollupSoftCredit_SVC - Contact/Account soft credit rollup logic",
          "CRLP_RollupAccSoftCredit_SVC - Account soft credit rollup logic",
          "CRLP_RollupGAU_SVC - General Accounting Unit rollup logic",
          "CRLP_RollupRD_SVC - Recurring Donation rollup logic",
          "CRLP_Rollup_SEL - Rollup metadata selector and cache",
          "CRLP_RollupProcessingOptions - Enums for RollupType, BatchJobMode, RollupTypeFilter",
          "CRLP_ApiService - Public API for rollup configuration"
        ],
        "batch_classes": [
          "CRLP_Batch_Base - Abstract base class for all rollup batches",
          "CRLP_Account_BATCH - Account hard credit batch rollups",
          "CRLP_Contact_BATCH - Contact hard credit batch rollups",
          "CRLP_Account_SoftCredit_BATCH - Account soft credit batch",
          "CRLP_Contact_SoftCredit_BATCH - Contact soft credit batch",
          "CRLP_Account_AccSoftCredit_BATCH - Account-level account soft credit batch",
          "CRLP_GAU_BATCH - GAU rollup batch",
          "CRLP_RD_BATCH - Recurring donation rollup batch",
          "CRLP_AccountSkew_BATCH - Skew mode for accounts with many opportunities",
          "CRLP_ContactSkew_BATCH - Skew mode for contacts",
          "CRLP_SkewDispatcher_BATCH - Dispatches skew mode processing",
          "CRLP_AccountSkew_SoftCredit_BATCH - Skew mode soft credits",
          "CRLP_AccountSkew_AccSoftCredit_BATCH - Skew mode account soft credits",
          "CRLP_ContactSkew_SoftCredit_BATCH - Skew mode contact soft credits",
          "CRLP_RDSkew_BATCH - Skew mode RD rollups"
        ],
        "legacy_batch_classes": [
          "RLLP_OppAccRollup_BATCH - Legacy account rollup batch",
          "RLLP_OppContactRollup_BATCH - Legacy contact rollup batch",
          "RLLP_OppHouseholdRollup_BATCH - Legacy household rollup batch",
          "RLLP_OppSoftCreditRollup_BATCH - Legacy soft credit rollup batch"
        ]
      },
      "data_objects": [
        "Rollup__mdt - Custom metadata defining each rollup (Summary_Object__c, Summary_Field__c, Detail_Object__c, Detail_Field__c, Operation__c, Amount_Field__c, Date_Field__c, Filter_Group__c, etc.)",
        "Filter_Group__mdt - Groups of filter rules applied to rollups",
        "Filter_Rule__mdt - Individual filter criteria (field, operator, value)",
        "Customizable_Rollup_Settings__c - Global CRLP settings (batch sizes, skew thresholds)"
      ],
      "rollup_mdt_fields": {
        "Active__c": "Boolean - is this rollup active",
        "Summary_Object__c": "Text - target object API name (Account, Contact, etc.)",
        "Summary_Field__c": "Text - target field API name on summary object",
        "Detail_Object__c": "Text - source object (Opportunity or npe01__OppPayment__c)",
        "Detail_Field__c": "Text - source field for the rollup value",
        "Amount_Object__c": "Text - object containing the amount field",
        "Amount_Field__c": "Text - the amount field to roll up",
        "Date_Object__c": "Text - object containing the date field",
        "Date_Field__c": "Text - date field for time-bound operations",
        "Operation__c": "Picklist - Sum, Count, Average, Largest, Smallest, First, Last, Best_Year, etc.",
        "Time_Bound_Operation_Type__c": "Picklist - All_Time, Years_Ago, Days_Back",
        "Integer__c": "Number - N value for 'Years_Ago' or 'Days_Back'",
        "Filter_Group__c": "Lookup - which filter group to apply",
        "Use_Fiscal_Year__c": "Boolean - use fiscal year instead of calendar year"
      },
      "connects_to": [
        "Donations & Payments - Source data for rollups",
        "Soft Credits - Rolled up separately from hard credits",
        "Allocations - GAU rollups",
        "Recurring Donations - RD rollup summaries",
        "Households - Account-level donor summary fields"
      ],
      "code_snippet": {
        "description": "CRLP_Rollup_TDTM real-time trigger handler",
        "language": "apex",
        "code": "// force-app/main/default/classes/CRLP_Rollup_TDTM.cls\npublic class CRLP_Rollup_TDTM extends TDTM_Runnable {\n\n    private static final Integer MAX_ALLOWED_QUEUED_JOBS = 5;\n    private static Set<Id> alreadyQueuedForRollupJob = new Set<Id>();\n\n    public override DmlWrapper run(List<SObject> newlist, List<SObject> oldlist,\n            TDTM_Runnable.Action triggerAction,\n            Schema.DescribeSObjectResult objResult) {\n\n        if (!CRLP_Rollup_SVC.isCustomizableRollupEngineEnabled) {\n            return null; // Falls back to legacy RLLP handlers\n        }\n\n        List<SObject> recordsToRecalculate = new List<SObject>();\n        for (Integer i = 0; i < (newlist == null ? oldlist.size() : newlist.size()); i++) {\n            SObject record = (newlist == null ? oldlist[i] : newlist[i]);\n            if (triggerAction == TDTM_Runnable.Action.AfterUpdate) {\n                if (isRollupRecalcNeeded(record, oldlist[i])) {\n                    recordsToRecalculate.add(record);\n                    recordsToRecalculate.add(oldlist[i]);\n                }\n            } else if (triggerAction == TDTM_Runnable.Action.AfterInsert ||\n                       triggerAction == TDTM_Runnable.Action.AfterDelete ||\n                       triggerAction == TDTM_Runnable.Action.AfterUndelete) {\n                recordsToRecalculate.add(record);\n            }\n        }\n        // Submits queueable job for async rollup processing\n    }\n}"
      },
      "code_snippet_2": {
        "description": "CRLP_RollupProcessor_SVC handler class routing by rollup type",
        "language": "apex",
        "code": "// force-app/main/default/classes/CRLP_RollupProcessor_SVC.cls\npublic static Type getHandlerClassType(\n        CRLP_RollupProcessingOptions.RollupType rollupType) {\n    Type handlerClass;\n    switch on (rollupType) {\n        when ContactSoftCredit, AccountContactSoftCredit {\n            handlerClass = CRLP_RollupSoftCredit_SVC.class;\n        }\n        when AccountSoftCredit {\n            handlerClass = CRLP_RollupAccSoftCredit_SVC.class;\n        }\n        when AccountHardCredit {\n            handlerClass = CRLP_RollupAccount_SVC.class;\n        }\n        when ContactHardCredit {\n            handlerClass = CRLP_RollupContact_SVC.class;\n        }\n        when GAU {\n            handlerClass = CRLP_RollupGAU_SVC.class;\n        }\n        when RecurringDonations {\n            handlerClass = CRLP_RollupRD_SVC.class;\n        }\n    }\n    return handlerClass;\n}"
      }
    },

    {
      "name": "Allocations & Fund Accounting",
      "description": "Allows nonprofits to split donation amounts across multiple General Accounting Units (GAUs) -- think of GAUs as funds, campaigns, or programs. Allocations can be percentage-based or fixed-amount, and NPSP enforces that allocations for a single Opportunity do not exceed the Opportunity amount. Allocation changes propagate between Opportunities and Payments, and from Recurring Donations to their child Opportunities.",
      "key_components": {
        "handler_classes": [
          "ALLO_Allocations_TDTM - Main handler on Allocation__c, npe01__OppPayment__c, and Opportunity objects",
          "ALLO_PaymentSync_TDTM - Synchronizes allocations between Opportunities and Payments",
          "ALLO_Multicurrency_TDTM - Currency adjustment handler on Campaign and Recurring Donation objects",
          "GAU_TDTM - Prevents deletion of GAUs with child allocations"
        ],
        "batch_classes": [
          "ALLO_MakeDefaultAllocations_BATCH - Creates default GAU allocations for existing records"
        ]
      },
      "data_objects": [
        "Allocation__c (npsp__Allocation__c) - Junction between Opportunity/Payment/RD and GAU",
        "General_Accounting_Unit__c - Represents a fund, program, or accounting category",
        "Allocations_Settings__c - Allocation configuration (default GAU, percentage enforcement)"
      ],
      "connects_to": [
        "Donations & Payments - Allocations are children of Opportunities and Payments",
        "Recurring Donations - RD allocations propagate to generated Opportunities",
        "Customizable Rollups - GAU rollup summaries (total allocated per fund)"
      ],
      "code_snippet": {
        "description": "ALLO_Allocations_TDTM handler pattern with settings facade",
        "language": "apex",
        "code": "// force-app/main/default/classes/ALLO_Allocations_TDTM.cls\npublic class ALLO_Allocations_TDTM extends TDTM_Runnable {\n\n    public Map<Id, alloWrapper> mapWrapper = new Map<Id, alloWrapper>();\n    public DmlWrapper dmlWrapper = new dmlWrapper();\n\n    public static Allocations_Settings__c settings =\n        UTIL_CustomSettingsFacade.getAllocationsSettings();\n\n    public static final npo02__Households_Settings__c householdSettings =\n        UTIL_CustomSettingsFacade.getHouseholdsSettings();\n\n    public override DmlWrapper run(List<SObject> newlist, List<SObject> oldlist,\n        TDTM_Runnable.Action triggerAction,\n        Schema.DescribeSObjectResult objResult) {\n        // Enforces allocation totals, calculates percentages,\n        // syncs between Opp and Payment allocations\n    }\n}"
      }
    },

    {
      "name": "Soft Credits & Account Soft Credits",
      "description": "Enables attribution of donation credit to contacts and organizations beyond the primary donor. Partial Soft Credits allow fractional amounts to be attributed to multiple individuals. Account Soft Credits roll up soft credit totals to organizational accounts. This system works through OpportunityContactRole records and the Partial_Soft_Credit__c custom object.",
      "key_components": {
        "handler_classes": [
          "PSC_PartialSoftCredit_TDTM - Validates partial soft credit records on insert/update",
          "PSC_Opportunity_TDTM - Manages Account Soft Credit records when Opportunities are updated",
          "OPP_AccountSoftCredit_TDTM - Validates Account Soft Credit records",
          "HH_OppContactRoles_TDTM - Creates household member contact roles for soft credit"
        ],
        "service_classes": [
          "PSC_ManageSoftCredits_CTRL - Controller for soft credit management UI"
        ]
      },
      "data_objects": [
        "Partial_Soft_Credit__c - Stores fractional soft credit amounts per contact per opportunity",
        "Account_Soft_Credit__c - Stores account-level soft credit summaries",
        "OpportunityContactRole (standard) - The foundation for soft credit attribution"
      ],
      "connects_to": [
        "Donations & Payments - Soft credits are alternative attributions of the same donation",
        "Customizable Rollups - Separate rollup types for soft credits vs hard credits",
        "Households - Household members get automatic soft credit"
      ],
      "code_snippet": {
        "description": "PSC_PartialSoftCredit_TDTM handler",
        "language": "apex",
        "code": "// Handler registration from TDTM_DefaultConfig:\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true,\n    Asynchronous__c = false,\n    Class__c = 'PSC_PartialSoftCredit_TDTM',\n    Load_Order__c = 1,\n    Object__c = 'Partial_Soft_Credit__c',\n    Trigger_Action__c = 'BeforeInsert;BeforeUpdate'\n));\n\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true,\n    Asynchronous__c = false,\n    Class__c = 'PSC_Opportunity_TDTM',\n    Load_Order__c = 4,\n    Object__c = 'Opportunity',\n    Trigger_Action__c = 'AfterUpdate'\n));"
      }
    },

    {
      "name": "Contacts & Household Management",
      "description": "NPSP's contact model centers on the Household Account model where each Contact belongs to a Household Account (an Account record of type 'Household'). NPSP automatically creates and manages Household Accounts when Contacts are created. It handles household naming (e.g., 'Smith & Jones Household'), contact merging with relationship preservation, 'Do Not Contact' automation, and the legacy Household object (npo02__Household__c).",
      "key_components": {
        "handler_classes": [
          "ACCT_IndividualAccounts_TDTM - Creates/manages Household Accounts for Contacts (fires on Contact)",
          "ACCT_Accounts_TDTM - Account-level management (fires on Account)",
          "ACCT_AccountMerge_TDTM - Handles post-merge cleanup for Accounts",
          "HH_Households_TDTM - Household naming and contact support (fires on Contact)",
          "HH_HHObject_TDTM - Legacy Household object support",
          "CON_ContactMerge_TDTM - Handles contact merge with relationship preservation",
          "CON_DoNotContact_TDTM - Enforces Do Not Contact settings",
          "CON_CascadeDeleteLookups_TDTM - Cascade delete support"
        ],
        "service_classes": [
          "HH_HouseholdNaming - Household name/greeting generation logic",
          "HH_HouseholdNaming_BATCH - Batch recalculation of household names"
        ]
      },
      "data_objects": [
        "Contact (standard) - Individual donors/constituents",
        "Account (standard) - Used as Household containers and organizational accounts",
        "npo02__Household__c - Legacy household object (pre-Account model)",
        "Household_Naming_Settings__c - Name/greeting format configuration",
        "npo02__Households_Settings__c - Household behavior settings"
      ],
      "connects_to": [
        "Donations & Payments - Contacts are donors, Accounts are roll-up targets",
        "Addresses - Household addresses shared by all household members",
        "Relationships - Contact-to-contact relationships",
        "Affiliations - Contact-to-organization links"
      ],
      "code_snippet": {
        "description": "ACCT_IndividualAccounts_TDTM - the most heavily loaded handler on Contact",
        "language": "apex",
        "code": "// Handler registration covering nearly all trigger events:\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true,\n    Asynchronous__c = false,\n    Class__c = 'ACCT_IndividualAccounts_TDTM',\n    Load_Order__c = 1,\n    Object__c = 'Contact',\n    Trigger_Action__c = 'BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate;AfterDelete;AfterUndelete'\n));\n\n// This handler:\n// - Creates Household Account when Contact is created without one\n// - Moves Contact between households on reparenting\n// - Updates household naming when contacts change\n// - Handles contact deletion cleanup"
      }
    },

    {
      "name": "Relationships",
      "description": "Tracks interpersonal relationships between Contacts (spouse, parent, employer, friend, etc.). Relationships are reciprocal -- creating a 'Father' relationship from Contact A to Contact B automatically creates a 'Son/Daughter' relationship from B to A. Relationships can also be auto-created from CampaignMember co-membership.",
      "key_components": {
        "handler_classes": [
          "REL_Relationships_TDTM - Main handler on npe4__Relationship__c, creates reciprocal records",
          "REL_Relationships_Con_TDTM - Handles Contact events (AfterInsert, AfterUpdate, AfterDelete)",
          "REL_Relationships_Cm_TDTM - Auto-creates relationships from CampaignMember records"
        ],
        "service_classes": [
          "REL_Utils - Relationship utility methods"
        ],
        "lwc_components": [
          "relationshipsNavigator - Visual relationship explorer",
          "relationshipsTreeGrid - Tree grid view of relationships"
        ]
      },
      "data_objects": [
        "npe4__Relationship__c - Stores directional relationships between Contacts",
        "npe4__Relationship_Settings__c - Relationship configuration",
        "Relationship_Sync_Excluded_Fields__c - Fields excluded from reciprocal sync"
      ],
      "connects_to": [
        "Contacts & Households - Relationships exist between contacts",
        "Contact Merge - Relationships are preserved during merges"
      ],
      "code_snippet": {
        "description": "Reciprocal relationship creation pattern from TDTM_DefaultConfig",
        "language": "apex",
        "code": "// Three separate handlers for the Relationships domain:\n\n// 1. On the Relationship object itself - creates reciprocals\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true, Class__c = 'REL_Relationships_TDTM',\n    Load_Order__c = 1, Object__c = 'npe4__Relationship__c',\n    Trigger_Action__c = 'AfterInsert;AfterUpdate;AfterDelete'));\n\n// 2. On Contact - syncs relationships when contacts change\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true, Class__c = 'REL_Relationships_Con_TDTM',\n    Load_Order__c = 2, Object__c = 'Contact',\n    Trigger_Action__c = 'AfterInsert;AfterUpdate;AfterDelete'));\n\n// 3. On CampaignMember - auto-creates relationships\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true, Class__c = 'REL_Relationships_Cm_TDTM',\n    Load_Order__c = 1, Object__c = 'CampaignMember',\n    Trigger_Action__c = 'AfterInsert;AfterUpdate'));"
      }
    },

    {
      "name": "Affiliations",
      "description": "Links Contacts to organizational Accounts (employer, board membership, volunteer organization, etc.). Supports primary affiliation designation. Unlike Relationships (contact-to-contact), Affiliations represent contact-to-organization connections.",
      "key_components": {
        "handler_classes": [
          "AFFL_Affiliations_TDTM - Fires on Account, Contact, AND npe5__Affiliation__c objects"
        ]
      },
      "data_objects": [
        "npe5__Affiliation__c - Junction object linking Contact to Account with role and status"
      ],
      "connects_to": [
        "Contacts & Households - Contacts are affiliated with organizations",
        "Account Management - Organization accounts are affiliation targets"
      ],
      "code_snippet": {
        "description": "AFFL_Affiliations_TDTM registered on three different objects",
        "language": "apex",
        "code": "// Same class registered on THREE objects with different load orders:\n\n// On Account (load order 2)\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true, Class__c = 'AFFL_Affiliations_TDTM',\n    Load_Order__c = 2, Object__c = 'Account',\n    Trigger_Action__c = 'AfterInsert;AfterUpdate'));\n\n// On Contact (load order 1)\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true, Class__c = 'AFFL_Affiliations_TDTM',\n    Load_Order__c = 1, Object__c = 'Contact',\n    Trigger_Action__c = 'AfterInsert;AfterUpdate'));\n\n// On Affiliation itself (load order 1)\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true, Class__c = 'AFFL_Affiliations_TDTM',\n    Load_Order__c = 1, Object__c = 'npe5__Affiliation__c',\n    Trigger_Action__c = 'AfterInsert;AfterUpdate;AfterDelete;AfterUndelete'));"
      }
    },

    {
      "name": "Address Management",
      "description": "Manages addresses as first-class objects (Address__c) linked to Accounts. Enables seasonal/mailing address support, address sharing across household members, and optional address verification/normalization through external services. When an Address__c record is updated, changes propagate to the parent Account and all household Contact records.",
      "key_components": {
        "handler_classes": [
          "ADDR_Addresses_TDTM - Main handler on Address__c; copies address to Account and Contacts",
          "ADDR_Contact_TDTM - Creates Address__c records from Contact address fields",
          "ADDR_Account_TDTM - Creates Address__c records from Account address fields",
          "ADDR_Validator_TDTM - Address verification/normalization (supports async execution)"
        ]
      },
      "data_objects": [
        "Address__c - Custom address object with full address fields",
        "Addr_Verification_Settings__c - Verification service configuration",
        "Address_Verification_Settings__c - Additional verification settings"
      ],
      "connects_to": [
        "Contacts & Households - Addresses are shared across household members",
        "Account Management - Address changes propagate to Account billing/shipping"
      ],
      "code_snippet": {
        "description": "Address handlers with async support for verification",
        "language": "apex",
        "code": "// Address handlers support optional async execution:\n\n// Address object handler (can run async for testing)\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true,\n    Asynchronous__c = ADDR_Address_TDTM_TestAsync,  // Configurable!\n    Class__c = 'ADDR_Addresses_TDTM',\n    Load_Order__c = 1, Object__c = 'Address__c',\n    Trigger_Action__c = 'BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate;AfterDelete'));\n\n// Verification handler (runs after address changes)\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true,\n    Asynchronous__c = ADDR_Validator_TDTM_TestAsync,\n    Class__c = 'ADDR_Validator_TDTM',\n    Load_Order__c = 1, Object__c = 'Address__c',\n    Trigger_Action__c = 'BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate'));"
      }
    },

    {
      "name": "Engagement Plans",
      "description": "Enables nonprofits to create templated sequences of Tasks (stewardship steps, follow-up calls, thank-you letters) that are automatically generated when assigned to a Contact, Account, or Opportunity. Templates define tasks with dependencies, delays, and assignment rules. Tasks roll up completion status back to the engagement plan.",
      "key_components": {
        "handler_classes": [
          "EP_EngagementPlans_TDTM - Validates plan lookups, creates Tasks from template (on Engagement_Plan__c)",
          "EP_EngagementPlanTaskValidation_TDTM - Validates engagement plan tasks",
          "EP_TaskRollup_TDTM - Rolls up task completion to engagement plans (on Task)",
          "EP_TaskDependency_TDTM - Manages task dependency chains (on Task)"
        ],
        "service_classes": [
          "EP_EngagementPlans_UTIL - Target object field resolution and validation"
        ]
      },
      "data_objects": [
        "Engagement_Plan_Template__c - Defines the template with task definitions",
        "Engagement_Plan_Task__c - Individual task definitions within a template",
        "Engagement_Plan__c - Instance of a template applied to a specific record"
      ],
      "connects_to": [
        "Contacts & Households - Plans are assigned to contacts",
        "Donations & Payments - Plans can be triggered by donations"
      ],
      "code_snippet": {
        "description": "EP_EngagementPlans_TDTM handler creating Tasks from templates",
        "language": "apex",
        "code": "// force-app/main/default/classes/EP_EngagementPlans_TDTM.cls\npublic with sharing class EP_EngagementPlans_TDTM extends TDTM_Runnable {\n\n    public override DmlWrapper run(List<SObject> newlist, List<SObject> oldlist,\n        TDTM_Runnable.Action triggerAction,\n        Schema.DescribeSObjectResult objResult) {\n\n        if (triggerAction == TDTM_Runnable.Action.BeforeInsert) {\n            for (Integer i = 0; i < newlist.size(); i++) {\n                Engagement_Plan__c newEP = (Engagement_Plan__c) newlist[i];\n                // Validate that plan has exactly one lookup to a parent object\n                String targetField = EP_EngagementPlans_UTIL.getTargetObjectField(newEP, true);\n            }\n        }\n        // AfterInsert: Creates Task records based on the template's EP_Task definitions\n        // Uses DML options for email sending on certain tasks\n    }\n}"
      }
    },

    {
      "name": "Batch Data Import (BDI)",
      "description": "A powerful data import engine with 66 Apex classes that allows bulk loading of donations, contacts, and other records through a staging object (DataImport__c). Supports field mapping customization through custom metadata, donation matching to avoid duplicates, and batch processing with progress tracking. The Gift Entry UI is built on top of BDI.",
      "key_components": {
        "handler_classes": [
          "BDI_DataImportBatch_TDTM - Trigger handler on DataImportBatch__c (BeforeInsert)",
          "BDI_DataImportBatchStatus_TDTM - Tracks batch status via DataImport__c records"
        ],
        "service_classes": [
          "BDI_DataImport_BATCH - Main batch processor implementing Database.Batchable",
          "BDI_DataImportService - Core data import service logic",
          "BDI_MappingService - Field mapping resolution",
          "BDI_MatchDonations - Donation matching logic to prevent duplicates",
          "BDI_ObjectMappingLogic - Object mapping and creation"
        ],
        "lwc_components": [
          "bdiFieldMappings - Field mapping configuration UI",
          "bdiFieldMappingModal - Field mapping edit modal",
          "bdiObjectMappings - Object mapping configuration UI",
          "bdiObjectMappingModal - Object mapping edit modal",
          "bdiBatchNumberSettings - Batch number configuration"
        ]
      },
      "data_objects": [
        "DataImport__c - Staging records with all import data in one flat row",
        "DataImportBatch__c - Groups DataImport__c records into batches",
        "Data_Import_Settings__c - Global import settings",
        "Data_Import_Field_Mapping__mdt - Custom metadata defining field-to-field mappings",
        "Data_Import_Field_Mapping_Set__mdt - Groups of field mappings",
        "Data_Import_Object_Mapping__mdt - Custom metadata defining object creation/matching",
        "Data_Import_Object_Mapping_Set__mdt - Groups of object mappings"
      ],
      "connects_to": [
        "Gift Entry - Built on top of BDI",
        "Donations & Payments - Creates opportunities and payments",
        "Contacts & Households - Creates/matches contacts and accounts",
        "Allocations - Creates allocations during import"
      ],
      "code_snippet": {
        "description": "BDI_DataImport_BATCH core batch processor",
        "language": "apex",
        "code": "// force-app/main/default/classes/BDI_DataImport_BATCH.cls\npublic class BDI_DataImport_BATCH implements Database.Batchable<sObject> {\n\n    private BDI_DataImportService dataImportService;\n    private String strSoql;\n    public Data_Import_Settings__c diSettings;\n    public Id batchId;\n    public Boolean isFromGiftEntryUI;\n    public List<Id> dataImportIds;\n\n    public BDI_DataImport_BATCH() {\n        this(null, false);\n    }\n\n    // Processes DataImport__c records, matching/creating:\n    //   1. Contacts and Accounts\n    //   2. Opportunities (with donation matching)\n    //   3. Payments\n    //   4. Allocations\n    //   5. Other mapped objects\n}"
      }
    },

    {
      "name": "Gift Entry",
      "description": "A modern Lightning-based gift entry experience built on top of BDI. Provides form templates, single gift entry, batch gift entry with table views, Elevate payment processing integration, and donation matching. The UI is entirely Lightning Web Components with configurable form templates.",
      "key_components": {
        "handler_classes": [
          "BGE_FormTemplate_TDTM - Prevents deletion of active form templates"
        ],
        "service_classes": [
          "GE_GiftEntryController - Main LWC Apex controller",
          "GE_FormRendererService - Form rendering logic",
          "GE_Template - Template management"
        ],
        "lwc_components": [
          "geGiftEntryFormApp - Main gift entry application",
          "geHome - Gift entry landing page",
          "geBatchGiftEntryHeader - Batch header component",
          "geBatchGiftEntryTable - Batch entry table",
          "geBatchWizard - Batch creation wizard",
          "geFormRenderer - Dynamic form renderer",
          "geFormField - Individual form field component",
          "geFormSection - Form section component",
          "geFormWidgetAllocation - Allocation widget",
          "geFormWidgetSoftCredit - Soft credit widget",
          "geFormWidgetTokenizeCard - Payment card tokenization",
          "geTemplateBuilder - Form template designer",
          "geTemplates - Template list view",
          "geDonationMatching - Donation matching UI",
          "geModalRecurringDonation - Recurring donation modal",
          "geReviewDonations - Donation review screen"
        ]
      },
      "data_objects": [
        "Form_Template__c - Stores form template configurations as JSON",
        "Gift_Entry_Settings__c - Gift entry configuration",
        "DataImport__c - Staging records (same as BDI)",
        "DataImportBatch__c - Batch grouping (same as BDI)"
      ],
      "connects_to": [
        "Batch Data Import (BDI) - Gift Entry uses BDI as its processing engine",
        "Payment Services (Elevate) - Credit card processing",
        "Donations & Payments - Creates opportunities and payments",
        "Soft Credits - Soft credit widget in gift entry forms",
        "Allocations - Allocation widget in gift entry forms"
      ],
      "code_snippet": {
        "description": "Gift Entry LWC component structure",
        "language": "javascript",
        "code": "// force-app/main/default/lwc/geGiftEntryFormApp/geGiftEntryFormApp.js\n// The main Gift Entry form application coordinates:\n//   geFormRenderer - renders form fields from template JSON\n//   geFormWidgetAllocation - manages allocation splits\n//   geFormWidgetSoftCredit - manages soft credit entries\n//   geFormWidgetTokenizeCard - handles Elevate card tokenization\n//   geDonationMatching - finds matching existing donations\n//\n// Data flow:\n//   User fills form -> DataImport__c staging record created ->\n//   BDI_DataImport_BATCH processes -> Opportunity + Payment created"
      }
    },

    {
      "name": "Levels (Donor Tiers)",
      "description": "Assigns donor tiers/levels based on rollup field values. For example, donors who have given over $10,000 lifetime could be automatically assigned 'Major Donor' level. Levels can target Account, Contact, or any object and are evaluated via a nightly batch job.",
      "key_components": {
        "handler_classes": [
          "LVL_Level_TDTM - Validates Level__c records on insert/update"
        ],
        "batch_classes": [
          "LVL_LevelAssign_BATCH - Nightly batch that evaluates all records against level criteria"
        ]
      },
      "data_objects": [
        "Level__c - Defines a level (name, criteria field, min/max values, target object)",
        "Levels_Settings__c - Level feature configuration"
      ],
      "connects_to": [
        "Customizable Rollups - Level criteria are based on rollup summary fields",
        "Contacts & Households - Levels are assigned to contacts and accounts"
      ],
      "code_snippet": {
        "description": "LVL_Level_TDTM validation handler",
        "language": "apex",
        "code": "// Level validation and batch assignment:\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true,\n    Class__c = 'LVL_Level_TDTM',\n    Load_Order__c = 1,\n    Object__c = 'Level__c',\n    Trigger_Action__c = 'BeforeInsert;BeforeUpdate'\n));\n\n// LVL_LevelAssign_BATCH runs nightly to:\n// 1. Query all Level__c definitions\n// 2. For each target object, query records with the criteria field\n// 3. Assign the appropriate level based on field value ranges\n// 4. Update Previous_Level__c and Level__c fields"
      }
    },

    {
      "name": "Matching Gifts",
      "description": "Tracks corporate matching gift programs where an employer matches employee donations. Links matching gift opportunities to the original donations and tracks matching gift status.",
      "key_components": {
        "handler_classes": [
          "MTCH_Opportunity_TDTM - Handles matching gift logic on Opportunity AfterUpdate"
        ]
      },
      "data_objects": [
        "Opportunity (standard) - Both the original and matching donations are Opportunities"
      ],
      "connects_to": [
        "Donations & Payments - Matching gifts are linked to original donations",
        "Affiliations - Employment affiliations identify matching gift eligibility"
      ],
      "code_snippet": {
        "description": "Matching gift handler registration",
        "language": "apex",
        "code": "handlers.add(new Trigger_Handler__c(\n    Active__c = true,\n    Class__c = 'MTCH_Opportunity_TDTM',\n    Load_Order__c = 1,\n    Object__c = 'Opportunity',\n    Trigger_Action__c = 'AfterUpdate'\n));"
      }
    },

    {
      "name": "Error Handling & Logging",
      "description": "A centralized error handling framework with 22 Apex classes. Catches exceptions from TDTM handlers, logs them to the Error__c custom object, and optionally sends email notifications. Provides retry logic and error record viewers.",
      "key_components": {
        "service_classes": [
          "ERR_Handler - Core error processing, converts DML results to Error__c records",
          "ERR_Notifier - Email notification for errors",
          "ERR_ExceptionHandler - Exception-to-error conversion",
          "ERR_RecordError - Record-level error tracking"
        ],
        "lwc_components": [
          "errRecordLog - Error log viewer component"
        ]
      },
      "data_objects": [
        "Error__c - Stores error records with context, stack trace, and record references",
        "Error_Settings__c - Error handling configuration (notification preferences)"
      ],
      "connects_to": [
        "TDTM Framework - Errors from handlers are caught and logged",
        "All Feature Areas - Any handler can generate errors that flow through ERR_Handler"
      ],
      "code_snippet": {
        "description": "ERR_Handler error processing pattern",
        "language": "apex",
        "code": "// force-app/main/default/classes/ERR_Handler.cls\npublic class ERR_Handler {\n\n    public class Errors {\n        public Boolean errorsExist = false;\n        public List<Error__c> errorRecords = new List<Error__c>();\n    }\n\n    // Processes DML results to detect and log errors:\n    // 1. Iterates Database.SaveResult[] or Database.UpsertResult[]\n    // 2. Creates Error__c records with full context\n    // 3. Does NOT store errors directly (caller handles after rollback)\n    // 4. ERR_Notifier sends email notifications if configured\n}"
      }
    },

    {
      "name": "Settings & Configuration",
      "description": "NPSP stores all configuration in 14+ Custom Settings objects, managed through a unified facade (UTIL_CustomSettingsFacade). The settings UI uses both Visualforce pages (STG_Panel* classes, 64 total) and LWC components. Installation and upgrade logic runs through STG_InstallScript.",
      "key_components": {
        "service_classes": [
          "UTIL_CustomSettingsFacade - Central facade for ALL settings retrieval",
          "STG_InstallScript - Package install/upgrade handler",
          "STG_PanelTDTM_CTRL - Settings panel for TDTM configuration",
          "STG_Panel*_CTRL - Individual settings panel controllers (20+ panels)"
        ],
        "lwc_components": [
          "gsChecklist - Getting started checklist",
          "gsChecklistSetup - Setup wizard",
          "gsApplicationStatus - Application status",
          "gsResources - Resource links"
        ]
      },
      "data_objects": [
        "npe01__Contacts_And_Orgs_Settings__c - Contact/account model settings",
        "npo02__Households_Settings__c - Household behavior settings",
        "npe03__Recurring_Donations_Settings__c - Recurring donation settings",
        "npe4__Relationship_Settings__c - Relationship settings",
        "Allocations_Settings__c - Allocation settings",
        "Customizable_Rollup_Settings__c - CRLP settings",
        "Data_Import_Settings__c - Data import settings",
        "Error_Settings__c - Error handling settings",
        "Addr_Verification_Settings__c - Address verification settings",
        "Household_Naming_Settings__c - Name/greeting format settings",
        "Levels_Settings__c - Level feature settings",
        "Gift_Entry_Settings__c - Gift entry settings",
        "Batch_Data_Entry_Settings__c - Legacy batch entry settings",
        "Package_Settings__c - Package-level settings"
      ],
      "connects_to": [
        "Every Feature Area - All features read configuration from custom settings via UTIL_CustomSettingsFacade"
      ],
      "code_snippet": {
        "description": "UTIL_CustomSettingsFacade pattern - unified settings access",
        "language": "apex",
        "code": "// force-app/main/default/classes/UTIL_CustomSettingsFacade.cls\npublic without sharing class UTIL_CustomSettingsFacade {\n\n    // In-memory caching to avoid redundant queries\n    static npe01__Contacts_And_Orgs_Settings__c contactsSettings;\n    static npo02__Households_Settings__c householdsSettings;\n    static npe03__Recurring_Donations_Settings__c recurringDonationsSettings;\n    static npe4__Relationship_Settings__c relationshipsSettings;\n    static Allocations_Settings__c allocationsSettings;\n    static Customizable_Rollup_Settings__c customizableRollupSettings;\n    static Data_Import_Settings__c dataImportSettings;\n    // ... 14+ settings objects cached\n\n    // Usage pattern throughout NPSP:\n    // PMT_Payment_TDTM:\n    //   UTIL_CustomSettingsFacade.getContactsSettings()\n    //       .Enforce_Accounting_Data_Consistency__c\n    // ALLO_Allocations_TDTM:\n    //   UTIL_CustomSettingsFacade.getAllocationsSettings()\n    // CRLP_Rollup_SVC:\n    //   UTIL_CustomSettingsFacade.getCustomizableRollupSettings()\n}"
      }
    },

    {
      "name": "Payment Services (Elevate Integration)",
      "description": "Integration with Salesforce Elevate for payment processing. Handles credit card tokenization, payment capture, refunds, and recurring payment management. 14 PS_ prefix classes manage the integration layer.",
      "key_components": {
        "service_classes": [
          "PS_CommitmentRequest - Builds Elevate commitment requests for recurring payments",
          "PS_Request - Base payment service request builder",
          "PS_IntegrationService - Core integration with Elevate APIs"
        ],
        "lwc_components": [
          "geFormWidgetTokenizeCard - Card tokenization form widget",
          "gePaymentGatewayManagement - Gateway configuration UI",
          "rd2EditPaymentInformationModal - RD payment info editor",
          "rd2ElevateCreditCardForm - Credit card entry form",
          "rd2ElevateInformation - Elevate status display",
          "psElevateTokenHandler - Token management service",
          "refundPayment - Payment refund component"
        ]
      },
      "data_objects": [
        "Payment_Services_Configuration__c - Elevate integration settings"
      ],
      "connects_to": [
        "Gift Entry - Card tokenization during gift entry",
        "Recurring Donations - Recurring payment processing",
        "Donations & Payments - Payment capture and refunds"
      ],
      "code_snippet": {
        "description": "Payment Services integration pattern",
        "language": "apex",
        "code": "// Payment Services classes handle Elevate API communication:\n// PS_CommitmentRequest - builds JSON payloads for recurring commitments\n// PS_Request - base class for all Elevate API requests\n// PS_IntegrationService - HTTP callout management\n//\n// LWC flow:\n// geFormWidgetTokenizeCard -> iframe -> Elevate tokenization service\n// -> token returned -> stored on DataImport__c.Payment_Method_Token__c\n// -> BDI processing captures the payment via Elevate API"
      }
    },

    {
      "name": "Cascade Delete",
      "description": "Implements soft cascade deletes through lookup relationships (which Salesforce does not natively cascade delete, unlike master-detail). When a parent record is deleted, child records are also deleted. When undeleted, children are restored. This prevents orphaned records.",
      "key_components": {
        "handler_classes": [
          "CON_CascadeDeleteLookups_TDTM - Contact cascade deletes",
          "ACCT_CascadeDeleteLookups_TDTM - Account cascade deletes",
          "CAM_CascadeDeleteLookups_TDTM - Campaign cascade deletes",
          "OPP_CascadeDeleteLookups_TDTM - Opportunity cascade deletes",
          "PMT_CascadeDeleteLookups_TDTM - Payment cascade deletes",
          "RD_CascadeDeleteLookups_TDTM - Recurring Donation cascade deletes",
          "CDL_CascadeDeleteLookups_TDTM - General cascade delete utility"
        ]
      },
      "data_objects": ["All objects with lookup relationships that need cascade behavior"],
      "connects_to": [
        "All Feature Areas - cascade delete is a cross-cutting concern"
      ],
      "code_snippet": {
        "description": "Cascade delete handlers - one per parent object type",
        "language": "apex",
        "code": "// All cascade delete handlers follow the same pattern:\nhandlers.add(new Trigger_Handler__c(\n    Active__c = true,\n    Class__c = 'OPP_CascadeDeleteLookups_TDTM',\n    Load_Order__c = 1,\n    Object__c = 'Opportunity',\n    Trigger_Action__c = 'BeforeDelete;AfterDelete;AfterUndelete'\n));\n\n// Flow: BeforeDelete validates no blocking conditions\n//       AfterDelete deletes child lookup records\n//       AfterUndelete restores previously deleted children"
      }
    },

    {
      "name": "User Management",
      "description": "Handles user deactivation events, reassigning open tasks and other records when a user is deactivated.",
      "key_components": {
        "handler_classes": [
          "USER_InActiveUser_TDTM - Fires on User AfterUpdate to handle deactivation"
        ]
      },
      "data_objects": ["User (standard)"],
      "connects_to": [
        "Engagement Plans - Reassigns EP tasks from deactivated users"
      ],
      "code_snippet": {
        "description": "User deactivation handler",
        "language": "apex",
        "code": "handlers.add(new Trigger_Handler__c(\n    Active__c = true,\n    Class__c = 'USER_InActiveUser_TDTM',\n    Load_Order__c = 0,\n    Object__c = 'User',\n    Trigger_Action__c = 'AfterUpdate'\n));"
      }
    },

    {
      "name": "Auto-Numbering",
      "description": "Provides automatic number generation for records, replacing Salesforce's standard auto-number with configurable naming patterns.",
      "key_components": {
        "handler_classes": [
          "AN_AutoNumber_TDTM - Auto-number generation handler"
        ]
      },
      "data_objects": [
        "AutoNumber__c - Stores auto-number configuration and current sequence"
      ],
      "connects_to": [
        "Donations & Payments - Auto-numbering for payment records",
        "Contacts & Households - Auto-numbering for contact or household records"
      ]
    }
  ],

  "trigger_execution_map": {
    "description": "Complete map of which TDTM handlers fire on which objects, in load order. This is the execution sequence for every DML operation in NPSP.",
    "Contact": [
      {"load_order": 0, "class": "HH_Households_TDTM", "actions": "BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate;AfterDelete", "domain": "Households"},
      {"load_order": 1, "class": "AFFL_Affiliations_TDTM", "actions": "AfterInsert;AfterUpdate", "domain": "Affiliations"},
      {"load_order": 1, "class": "ACCT_IndividualAccounts_TDTM", "actions": "BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate;AfterDelete;AfterUndelete", "domain": "Accounts"},
      {"load_order": 1, "class": "CON_CascadeDeleteLookups_TDTM", "actions": "BeforeDelete;AfterDelete;AfterUndelete", "domain": "Cascade Delete"},
      {"load_order": 2, "class": "REL_Relationships_Con_TDTM", "actions": "AfterInsert;AfterUpdate;AfterDelete", "domain": "Relationships"},
      {"load_order": 2, "class": "ADDR_Contact_TDTM", "actions": "BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate", "domain": "Addresses"},
      {"load_order": 2, "class": "CON_DoNotContact_TDTM", "actions": "BeforeInsert;BeforeUpdate", "domain": "Contact Management"},
      {"load_order": 3, "class": "CON_ContactMerge_TDTM", "actions": "AfterDelete", "domain": "Contact Merge"}
    ],
    "Account": [
      {"load_order": 1, "class": "ACCT_Accounts_TDTM", "actions": "BeforeInsert;BeforeUpdate;AfterUpdate", "domain": "Accounts"},
      {"load_order": 1, "class": "ACCT_AccountMerge_TDTM", "actions": "AfterDelete", "domain": "Account Merge"},
      {"load_order": 1, "class": "ADDR_Account_TDTM", "actions": "BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate", "domain": "Addresses"},
      {"load_order": 1, "class": "ACCT_CascadeDeleteLookups_TDTM", "actions": "BeforeDelete;AfterDelete;AfterUndelete", "domain": "Cascade Delete"},
      {"load_order": 2, "class": "AFFL_Affiliations_TDTM", "actions": "AfterInsert;AfterUpdate", "domain": "Affiliations"}
    ],
    "Opportunity": [
      {"load_order": 0, "class": "OPP_OpportunityContactRoles_TDTM", "actions": "BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate", "domain": "Contact Roles"},
      {"load_order": 1, "class": "HH_OppContactRoles_TDTM", "actions": "AfterInsert;AfterUpdate", "domain": "Household Contact Roles"},
      {"load_order": 1, "class": "PMT_Payment_TDTM", "actions": "BeforeUpdate;AfterInsert;AfterUpdate", "domain": "Payments"},
      {"load_order": 1, "class": "RD_RecurringDonations_Opp_TDTM", "actions": "AfterInsert;AfterUpdate", "domain": "Legacy Recurring Donations"},
      {"load_order": 1, "class": "RLLP_OppRollup_TDTM", "actions": "AfterInsert;AfterUpdate;AfterDelete", "domain": "Legacy Rollups"},
      {"load_order": 1, "class": "MTCH_Opportunity_TDTM", "actions": "AfterUpdate", "domain": "Matching Gifts"},
      {"load_order": 1, "class": "OPP_CascadeDeleteLookups_TDTM", "actions": "BeforeDelete;AfterDelete;AfterUndelete", "domain": "Cascade Delete"},
      {"load_order": 2, "class": "RD2_RecurringDonationsOpp_TDTM", "actions": "BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate;AfterDelete", "domain": "Enhanced Recurring Donations"},
      {"load_order": 2, "class": "ALLO_Allocations_TDTM", "actions": "AfterInsert;AfterUpdate", "domain": "Allocations"},
      {"load_order": 3, "class": "OPP_CampaignMember_TDTM", "actions": "AfterInsert;AfterUpdate", "domain": "Campaign Members"},
      {"load_order": 4, "class": "PSC_Opportunity_TDTM", "actions": "AfterUpdate", "domain": "Partial Soft Credits"},
      {"load_order": 4, "class": "CRLP_Rollup_TDTM", "actions": "AfterInsert;AfterUpdate;AfterDelete;AfterUndelete", "domain": "Customizable Rollups"}
    ],
    "npe01__OppPayment__c": [
      {"load_order": 0, "class": "PMT_Payment_TDTM", "actions": "BeforeUpdate;BeforeInsert;AfterInsert;AfterUpdate", "domain": "Payments"},
      {"load_order": 1, "class": "ALLO_Allocations_TDTM", "actions": "AfterInsert;AfterUpdate", "domain": "Allocations"},
      {"load_order": 1, "class": "PMT_CascadeDeleteLookups_TDTM", "actions": "BeforeDelete;AfterDelete;AfterUndelete", "domain": "Cascade Delete"},
      {"load_order": 2, "class": "CRLP_Rollup_TDTM", "actions": "AfterInsert;AfterUpdate;AfterDelete;AfterUndelete", "domain": "Customizable Rollups"}
    ],
    "npe03__Recurring_Donation__c": [
      {"load_order": 1, "class": "RD_RecurringDonations_TDTM", "actions": "BeforeDelete;BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate", "domain": "Legacy RD"},
      {"load_order": 1, "class": "ALLO_Multicurrency_TDTM", "actions": "AfterUpdate", "domain": "Multicurrency Allocations"},
      {"load_order": 1, "class": "RD_CascadeDeleteLookups_TDTM", "actions": "BeforeDelete;AfterDelete;AfterUndelete", "domain": "Cascade Delete"},
      {"load_order": 2, "class": "RD2_RecurringDonations_TDTM", "actions": "BeforeDelete;BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate;AfterDelete;AfterUndelete", "domain": "Enhanced RD"}
    ],
    "Allocation__c": [
      {"load_order": 1, "class": "ALLO_Allocations_TDTM", "actions": "BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate;AfterDelete", "domain": "Allocations"},
      {"load_order": 4, "class": "ALLO_PaymentSync_TDTM", "actions": "AfterInsert;AfterUpdate;AfterDelete", "domain": "Payment Sync"}
    ],
    "Address__c": [
      {"load_order": 1, "class": "ADDR_Addresses_TDTM", "actions": "BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate;AfterDelete", "domain": "Addresses"},
      {"load_order": 1, "class": "ADDR_Validator_TDTM", "actions": "BeforeInsert;BeforeUpdate;AfterInsert;AfterUpdate", "domain": "Address Verification"}
    ],
    "npe4__Relationship__c": [
      {"load_order": 1, "class": "REL_Relationships_TDTM", "actions": "AfterInsert;AfterUpdate;AfterDelete", "domain": "Relationships"}
    ],
    "npe5__Affiliation__c": [
      {"load_order": 1, "class": "AFFL_Affiliations_TDTM", "actions": "AfterInsert;AfterUpdate;AfterDelete;AfterUndelete", "domain": "Affiliations"}
    ],
    "npo02__Household__c": [
      {"load_order": 1, "class": "HH_HHObject_TDTM", "actions": "BeforeUpdate;AfterUpdate", "domain": "Legacy Households"}
    ],
    "Engagement_Plan__c": [
      {"load_order": 0, "class": "EP_EngagementPlans_TDTM", "actions": "BeforeInsert;BeforeUpdate;AfterInsert", "domain": "Engagement Plans"}
    ],
    "Engagement_Plan_Task__c": [
      {"load_order": 1, "class": "EP_EngagementPlanTaskValidation_TDTM", "actions": "AfterInsert;AfterUpdate", "domain": "Engagement Plans"}
    ],
    "Task": [
      {"load_order": 0, "class": "EP_TaskRollup_TDTM", "actions": "AfterInsert;AfterUpdate;AfterDelete;AfterUndelete", "domain": "Engagement Plans"},
      {"load_order": 1, "class": "EP_TaskDependency_TDTM", "actions": "AfterUpdate", "domain": "Engagement Plans"}
    ],
    "CampaignMember": [
      {"load_order": 1, "class": "REL_Relationships_Cm_TDTM", "actions": "AfterInsert;AfterUpdate", "domain": "Relationships"}
    ],
    "Campaign": [
      {"load_order": 1, "class": "ALLO_Multicurrency_TDTM", "actions": "AfterUpdate", "domain": "Multicurrency Allocations"},
      {"load_order": 1, "class": "CAM_CascadeDeleteLookups_TDTM", "actions": "BeforeDelete;AfterDelete;AfterUndelete", "domain": "Cascade Delete"}
    ],
    "DataImportBatch__c": [
      {"load_order": 1, "class": "BDI_DataImportBatch_TDTM", "actions": "BeforeInsert", "domain": "Batch Data Import"}
    ],
    "DataImport__c": [
      {"load_order": 1, "class": "BDI_DataImportBatchStatus_TDTM", "actions": "AfterInsert;AfterUpdate;AfterUndelete;AfterDelete", "domain": "Batch Data Import"}
    ],
    "Level__c": [
      {"load_order": 1, "class": "LVL_Level_TDTM", "actions": "BeforeInsert;BeforeUpdate", "domain": "Levels"}
    ],
    "Partial_Soft_Credit__c": [
      {"load_order": 1, "class": "PSC_PartialSoftCredit_TDTM", "actions": "BeforeInsert;BeforeUpdate", "domain": "Soft Credits"}
    ],
    "Account_Soft_Credit__c": [
      {"load_order": 1, "class": "OPP_AccountSoftCredit_TDTM", "actions": "BeforeInsert;BeforeUpdate", "domain": "Soft Credits"}
    ],
    "General_Accounting_Unit__c": [
      {"load_order": 1, "class": "GAU_TDTM", "actions": "BeforeDelete", "domain": "Fund Accounting"}
    ],
    "Form_Template__c": [
      {"load_order": 1, "class": "BGE_FormTemplate_TDTM", "actions": "BeforeDelete", "domain": "Gift Entry"}
    ],
    "User": [
      {"load_order": 0, "class": "USER_InActiveUser_TDTM", "actions": "AfterUpdate", "domain": "User Management"}
    ]
  },

  "batch_jobs": {
    "description": "NPSP relies heavily on batch Apex for asynchronous processing. Several jobs run on nightly schedules, while others are triggered by real-time events or run on-demand.",
    "scheduled_nightly": [
      {
        "name": "CRLP_Account_BATCH / CRLP_Contact_BATCH / CRLP_GAU_BATCH",
        "description": "Nightly full recalculation of all customizable rollup summaries across Account, Contact, and GAU objects."
      },
      {
        "name": "RD2_OpportunityEvaluation_BATCH",
        "description": "Evaluates all active recurring donations, creates new installment Opportunities as they come due, and handles status automation (lapsed, closed)."
      },
      {
        "name": "LVL_LevelAssign_BATCH",
        "description": "Evaluates all Level__c definitions against target records and assigns/updates donor tier levels."
      },
      {
        "name": "RLLP_OppAccRollup_BATCH / RLLP_OppContactRollup_BATCH / RLLP_OppHouseholdRollup_BATCH",
        "description": "Legacy rollup batch jobs (run when CRLP is not enabled). Recalculate opportunity rollup summaries."
      },
      {
        "name": "UTIL_OrgTelemetry_BATCH",
        "description": "Collects anonymous usage telemetry for NPSP product improvement."
      }
    ],
    "event_triggered": [
      {
        "name": "CRLP_SkewDispatcher_BATCH",
        "description": "Dispatched when a record has too many child detail records for normal rollup processing (skew mode threshold, default 250 child records)."
      },
      {
        "name": "HH_HouseholdNaming_BATCH",
        "description": "Batch recalculation of household names and greetings when naming settings change."
      },
      {
        "name": "OPP_OpportunityNaming_BATCH",
        "description": "Batch renaming of opportunities when naming conventions change."
      },
      {
        "name": "OPP_PrimaryContact_BATCH",
        "description": "Batch update of primary contact designations on opportunities."
      }
    ],
    "on_demand": [
      {
        "name": "BDI_DataImport_BATCH",
        "description": "Processes a batch of DataImport__c staging records, creating/matching Contacts, Accounts, Opportunities, Payments, and Allocations."
      },
      {
        "name": "ALLO_MakeDefaultAllocations_BATCH",
        "description": "Creates default GAU allocations for existing Opportunities that lack them."
      },
      {
        "name": "RD2_DataMigration_BATCH / RD2_DataMigrationDryRun_BATCH",
        "description": "Migrates recurring donation records from legacy format to enhanced RD2 format."
      },
      {
        "name": "CONV_Account_Conversion_BATCH",
        "description": "Converts between account models (One-to-One vs Household vs Individual Bucket)."
      },
      {
        "name": "HH_CampaignDedupe_BATCH",
        "description": "Deduplicates campaign members from the same household."
      },
      {
        "name": "PMT_PaymentCreator_BATCH",
        "description": "Batch creation of payment records for existing opportunities."
      }
    ]
  },

  "data_model": {
    "description": "NPSP's data model extends Salesforce with 65 custom objects, custom metadata types, and platform events. The core model uses standard Salesforce objects (Account, Contact, Opportunity) in a nonprofit context alongside custom objects for payments, recurring donations, allocations, relationships, and more.",
    "core_objects": {
      "standard_objects_repurposed": [
        {
          "name": "Account",
          "npsp_usage": "Represents Households (Account.RecordType = 'Household') and Organizations. In the Household Account model, each household is an Account containing multiple Contact members.",
          "key_npsp_fields": "npo02__TotalOppAmount__c, npo02__NumberOfClosedOpps__c, npo02__LastCloseDate__c, npo02__Best_Gift_Year__c"
        },
        {
          "name": "Contact",
          "npsp_usage": "Represents individual donors, volunteers, and constituents. Every Contact belongs to a Household Account.",
          "key_npsp_fields": "npo02__TotalOppAmount__c, npe01__Primary_Address_Type__c, npsp__Primary_Affiliation__c"
        },
        {
          "name": "Opportunity",
          "npsp_usage": "Represents donations/gifts. Stage maps to donation status (pledged, received, etc.).",
          "key_npsp_fields": "npsp__Primary_Contact__c, npe03__Recurring_Donation__c, npsp__Honoree_Contact__c"
        }
      ],
      "custom_objects": [
        {
          "api_name": "npe01__OppPayment__c",
          "label": "Payment",
          "description": "Child of Opportunity. Tracks individual payment installments with date, amount, paid status, and payment method.",
          "key_fields": ["npe01__Opportunity__c (Lookup to Opportunity)", "npe01__Payment_Date__c", "npe01__Payment_Amount__c", "npe01__Paid__c", "npe01__Payment_Method__c"]
        },
        {
          "api_name": "npe03__Recurring_Donation__c",
          "label": "Recurring Donation",
          "description": "Defines a recurring gift schedule. Links to Contact or Account as donor. The RD2 engine generates child Opportunities on schedule.",
          "key_fields": ["npe03__Contact__c", "npe03__Organization__c", "npe03__Amount__c", "npe03__Installment_Period__c", "npsp__Status__c", "npsp__Day_of_Month__c"]
        },
        {
          "api_name": "Allocation__c",
          "label": "GAU Allocation",
          "description": "Junction between Opportunity/Payment/RD and General_Accounting_Unit__c. Represents how donation amounts are split across funds.",
          "key_fields": ["npsp__Opportunity__c", "npsp__Payment__c", "npsp__Recurring_Donation__c", "npsp__General_Accounting_Unit__c", "npsp__Amount__c", "npsp__Percent__c"]
        },
        {
          "api_name": "General_Accounting_Unit__c",
          "label": "General Accounting Unit (GAU)",
          "description": "Represents a fund, program, campaign, or cost center. Rollup fields summarize total allocations.",
          "key_fields": ["npsp__Total_Allocations__c", "npsp__Total_Number_of_Allocations__c", "npsp__Active__c"]
        },
        {
          "api_name": "npe4__Relationship__c",
          "label": "Relationship",
          "description": "Stores directional interpersonal relationships between two Contacts (e.g., spouse, parent, employer).",
          "key_fields": ["npe4__Contact__c", "npe4__RelatedContact__c", "npe4__Type__c", "npe4__Status__c", "npe4__ReciprocalRelationship__c"]
        },
        {
          "api_name": "npe5__Affiliation__c",
          "label": "Affiliation",
          "description": "Links a Contact to an organizational Account (employer, board member, volunteer, etc.).",
          "key_fields": ["npe5__Contact__c", "npe5__Organization__c", "npe5__Role__c", "npe5__Status__c", "npe5__Primary__c"]
        },
        {
          "api_name": "Address__c",
          "label": "Address",
          "description": "First-class address object linked to Account. Supports multiple addresses per household with default and seasonal designations.",
          "key_fields": ["npsp__Household_Account__c", "npsp__Default_Address__c", "npsp__Seasonal_Start_Month__c", "npsp__MailingStreet__c", "npsp__MailingCity__c"]
        },
        {
          "api_name": "Engagement_Plan_Template__c",
          "label": "Engagement Plan Template",
          "description": "Defines a reusable template of tasks/steps for donor stewardship, onboarding, or follow-up workflows.",
          "key_fields": ["Name", "npsp__Description__c", "npsp__Skip_Weekends__c", "npsp__Default_Assignee__c"]
        },
        {
          "api_name": "Engagement_Plan_Task__c",
          "label": "Engagement Plan Task",
          "description": "Individual task definition within an Engagement Plan Template. Supports dependencies and priority.",
          "key_fields": ["npsp__Engagement_Plan_Template__c", "npsp__Priority__c", "npsp__Days_After__c", "npsp__Type__c", "npsp__Dependent_EP_Task__c"]
        },
        {
          "api_name": "Engagement_Plan__c",
          "label": "Engagement Plan",
          "description": "Instance of a template applied to a specific Contact, Account, or other record.",
          "key_fields": ["npsp__Engagement_Plan_Template__c", "npsp__Contact__c", "npsp__Account__c"]
        },
        {
          "api_name": "Level__c",
          "label": "Level",
          "description": "Defines donor tier criteria (e.g., Major Donor = $10k+ lifetime giving).",
          "key_fields": ["npsp__Target__c", "npsp__Source_Field__c", "npsp__Minimum_Amount__c", "npsp__Maximum_Amount__c", "npsp__Level_Field__c"]
        },
        {
          "api_name": "DataImport__c",
          "label": "NPSP Data Import",
          "description": "Staging object for batch data import. Contains fields for Contact, Account, Opportunity, Payment, and Allocation data in a single flat record.",
          "key_fields": ["npsp__Contact1_Firstname__c", "npsp__Contact1_Lastname__c", "npsp__Donation_Amount__c", "npsp__Donation_Date__c", "npsp__Status__c"]
        },
        {
          "api_name": "DataImportBatch__c",
          "label": "NPSP Data Import Batch",
          "description": "Groups DataImport__c records into a named batch for processing.",
          "key_fields": ["Name", "npsp__Batch_Status__c", "npsp__Records_Processed__c", "npsp__Records_Failed__c"]
        },
        {
          "api_name": "Error__c",
          "label": "Error",
          "description": "Stores NPSP error records with full context for debugging.",
          "key_fields": ["npsp__Error_Type__c", "npsp__Full_Message__c", "npsp__Stack_Trace__c", "npsp__Record_URL__c", "npsp__Context_Type__c"]
        },
        {
          "api_name": "Partial_Soft_Credit__c",
          "label": "Partial Soft Credit",
          "description": "Stores fractional soft credit amounts for contacts who partially contributed to an opportunity.",
          "key_fields": ["npsp__Contact__c", "npsp__Opportunity__c", "npsp__Amount__c", "npsp__Role_Name__c"]
        },
        {
          "api_name": "Account_Soft_Credit__c",
          "label": "Account Soft Credit",
          "description": "Organization-level soft credit records for account-level attribution.",
          "key_fields": ["npsp__Account__c", "npsp__Opportunity__c", "npsp__Amount__c", "npsp__Role__c"]
        },
        {
          "api_name": "RecurringDonationSchedule__c",
          "label": "Recurring Donation Schedule",
          "description": "Individual installment schedule entries for enhanced recurring donations.",
          "key_fields": ["npsp__RecurringDonation__c", "npsp__InstallmentAmount__c", "npsp__InstallmentFrequency__c", "npsp__StartDate__c"]
        },
        {
          "api_name": "RecurringDonationChangeLog__c",
          "label": "Recurring Donation Change Log",
          "description": "Audit trail of changes made to recurring donation records.",
          "key_fields": ["npsp__RecurringDonation__c", "npsp__ChangeType__c", "npsp__EffectiveDate__c"]
        },
        {
          "api_name": "Trigger_Handler__c",
          "label": "Trigger Handler",
          "description": "Configuration records for TDTM. Each record maps a handler class to an object and trigger actions.",
          "key_fields": ["Class__c", "Object__c", "Trigger_Action__c", "Load_Order__c", "Active__c", "Asynchronous__c"]
        },
        {
          "api_name": "Schedulable__c",
          "label": "Schedulable",
          "description": "Tracks scheduled NPSP batch jobs.",
          "key_fields": ["Name", "npsp__Class_Name__c", "npsp__Active__c"]
        }
      ],
      "custom_metadata_types": [
        {
          "api_name": "Rollup__mdt",
          "description": "Defines each customizable rollup: source object/field, target object/field, operation, and filter group."
        },
        {
          "api_name": "Filter_Group__mdt",
          "description": "Groups of filter rules applied to CRLP rollups."
        },
        {
          "api_name": "Filter_Rule__mdt",
          "description": "Individual filter criteria within a filter group."
        },
        {
          "api_name": "Data_Import_Field_Mapping__mdt",
          "description": "Maps DataImport__c fields to target object fields."
        },
        {
          "api_name": "Data_Import_Object_Mapping__mdt",
          "description": "Defines object creation/matching rules for data import."
        },
        {
          "api_name": "Opportunity_Stage_To_State_Mapping__mdt",
          "description": "Maps Opportunity stages to states (Open/Closed Won/Closed Lost)."
        },
        {
          "api_name": "RecurringDonationStatusMapping__mdt",
          "description": "Maps recurring donation statuses for automation."
        },
        {
          "api_name": "GetStartedChecklistItem__mdt / GetStartedChecklistSection__mdt",
          "description": "Defines the getting-started wizard checklist items."
        },
        {
          "api_name": "Custom_Notification__mdt",
          "description": "Configuration for platform event-based notifications."
        }
      ],
      "platform_events": [
        {
          "api_name": "DeploymentEvent__e",
          "description": "Fired during metadata deployment operations (e.g., CRLP rollup deployment)."
        }
      ],
      "custom_settings": [
        "npe01__Contacts_And_Orgs_Settings__c",
        "npo02__Households_Settings__c",
        "npe03__Recurring_Donations_Settings__c",
        "npe4__Relationship_Settings__c",
        "Allocations_Settings__c",
        "Customizable_Rollup_Settings__c",
        "Data_Import_Settings__c",
        "Error_Settings__c",
        "Addr_Verification_Settings__c",
        "Household_Naming_Settings__c",
        "Levels_Settings__c",
        "Gift_Entry_Settings__c",
        "Batch_Data_Entry_Settings__c",
        "Package_Settings__c",
        "Opportunity_Naming_Settings__c"
      ]
    }
  },

  "key_apex_classes": {
    "description": "The most important Apex classes organized by role in the architecture",
    "framework_classes": [
      {
        "name": "TDTM_TriggerHandler",
        "purpose": "The central dispatcher. Called from every trigger, reads Trigger_Handler__c records, instantiates handler classes via reflection, calls their run() method in load order, and processes the collected DmlWrapper.",
        "file_path": "force-app/tdtm/classes/TDTM_TriggerHandler.cls"
      },
      {
        "name": "TDTM_Runnable",
        "purpose": "Global abstract base class that all TDTM handler classes must extend. Defines the run() method signature, DmlWrapper inner class for collecting DML operations, and Action enum for trigger events. Also provides @future method support for async execution.",
        "file_path": "force-app/tdtm/classes/TDTM_Runnable.cls"
      },
      {
        "name": "TDTM_DefaultConfig",
        "purpose": "Static factory that returns the default set of ~50 Trigger_Handler__c records. These are inserted on first trigger execution if no handlers exist. This is the 'wiring diagram' of the entire application.",
        "file_path": "force-app/tdtm/classes/TDTM_DefaultConfig.cls"
      },
      {
        "name": "UTIL_CustomSettingsFacade",
        "purpose": "Unified access point for all 14+ custom settings objects. Provides in-memory caching, handles org-level vs user-level settings, and prevents duplicate OwnerId errors. Used by virtually every handler class.",
        "file_path": "force-app/main/default/classes/UTIL_CustomSettingsFacade.cls"
      },
      {
        "name": "ERR_Handler",
        "purpose": "Central error processing. Converts Database.SaveResult/UpsertResult arrays into Error__c records. Used throughout NPSP for consistent error handling.",
        "file_path": "force-app/main/default/classes/ERR_Handler.cls"
      }
    ],
    "domain_service_classes": [
      {
        "name": "CRLP_Rollup_SVC",
        "purpose": "Core CRLP service. Determines if CRLP is enabled, provides rollup definition access, and coordinates rollup processing.",
        "file_path": "force-app/main/default/classes/CRLP_Rollup_SVC.cls"
      },
      {
        "name": "CRLP_RollupProcessor_SVC",
        "purpose": "Routes rollup processing to the correct handler class (Account, Contact, SoftCredit, GAU, or RD) based on the rollup type enum.",
        "file_path": "force-app/main/default/classes/CRLP_RollupProcessor_SVC.cls"
      },
      {
        "name": "RD2_ScheduleService",
        "purpose": "The scheduling brain for enhanced recurring donations. Calculates installment dates, amounts, and determines which opportunities need to be created.",
        "file_path": "force-app/main/default/classes/RD2_ScheduleService.cls"
      },
      {
        "name": "BDI_DataImportService",
        "purpose": "Core service for the Batch Data Import engine. Processes DataImport__c records through matching, validation, and record creation pipelines.",
        "file_path": "force-app/main/default/classes/BDI_DataImportService.cls"
      },
      {
        "name": "HH_HouseholdNaming",
        "purpose": "Generates household names, formal greetings, and informal greetings from constituent Contact records using configurable naming patterns.",
        "file_path": "force-app/main/default/classes/HH_HouseholdNaming.cls"
      },
      {
        "name": "UTIL_Describe",
        "purpose": "SObject and field describe cache. Prevents redundant describe calls across the transaction by caching DescribeSObjectResult and DescribeFieldResult objects.",
        "file_path": "force-app/main/default/classes/UTIL_Describe.cls"
      }
    ]
  },

  "strategic_insights": {
    "description": "Second-order effects and architectural patterns worth understanding for anyone building on or migrating from NPSP",
    "patterns": [
      {
        "insight": "TDTM as a Managed Package Strategy",
        "explanation": "TDTM was not just an engineering pattern -- it was a product strategy. By making trigger logic configurable via data (Trigger_Handler__c records), NPSP enabled ISVs and consultants to extend the platform without conflicting with NPSP triggers. This is why NPSP succeeded in a managed package ecosystem where trigger conflicts are the #1 cause of installation failures."
      },
      {
        "insight": "The CRLP/RLLP Dual Engine Problem",
        "explanation": "NPSP maintains TWO rollup engines simultaneously: legacy RLLP (hardcoded) and CRLP (metadata-driven). Both sets of handlers are registered in TDTM_DefaultConfig. CRLP_Rollup_TDTM checks isCustomizableRollupEngineEnabled and returns null if not enabled, falling through to the legacy RLLP_OppRollup_TDTM. This dual-engine architecture adds complexity but ensures backward compatibility."
      },
      {
        "insight": "Custom Settings as a Configuration Moat",
        "explanation": "NPSP's 14+ custom settings objects, accessed through UTIL_CustomSettingsFacade, create a significant migration barrier. Every feature reads from these settings, and they are deeply embedded in the codebase. This is one reason the Nonprofit Cloud migration is complex -- the configuration surface area is enormous."
      },
      {
        "insight": "Skew Mode as a Scale Escape Hatch",
        "explanation": "The CRLP engine's dual-mode processing (NonSkew vs SkewMode) solves Salesforce's governor limit problem for large data volumes. Organizations with mega-donors (250+ child records) automatically switch to skew mode, which queries detail records instead of summary records. This pattern is worth studying for any Salesforce application that needs to handle variable data volumes."
      },
      {
        "insight": "BDI as an Internal Platform",
        "explanation": "The Batch Data Import engine evolved from a simple import tool into an internal platform. Gift Entry, the most modern NPSP feature, is built entirely on top of BDI. The DataImport__c staging object and the field/object mapping metadata architecture make BDI a general-purpose data processing pipeline, not just an import tool."
      },
      {
        "insight": "The Handler Load Order Problem",
        "explanation": "Load ordering in TDTM creates implicit coupling between handlers. For example, on the Contact object, HH_Households_TDTM runs at load order 0 (before everything else) because household assignment must happen before address management (load order 2) and relationship processing (load order 2). Changing load orders without understanding these dependencies can break the application in subtle ways."
      }
    ]
  }
}
